name: Backend CI/CD

on:
  push:
    branches:
      - main

jobs:
  backend-ci:
    runs-on: ubuntu-latest

    defaults:
      run:
        working-directory: backend

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set Java JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v3

      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      - name: Run build
        run: ./gradlew clean build -x test -i --no-daemon -Dspring.profiles.active=prod

      - name: Login to Docker Hub
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Build Docker image
        run: docker build -t ${{ secrets.DOCKER_USERNAME }}/${{ secrets.DOCKER_REPO }} .

      - name: Push Docker image
        run: docker push ${{ secrets.DOCKER_USERNAME }}/${{ secrets.DOCKER_REPO }}

  backend-cd:
    runs-on: ubuntu-latest
    needs: backend-ci
    name: Deploy to EC2 (blue/green)

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Deploy to EC2 (blue/green)
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.AWS_EC2_IP }}
          username: ${{ secrets.AWS_EC2_USERNAME }}
          key: ${{ secrets.AWS_EC2_KEY }}
          port: ${{ secrets.AWS_EC2_PORT }}
          script: |
            cd /home/ubuntu

            APP_NAME=${{ secrets.DOCKER_REPO }}
            IMAGE=${{ secrets.DOCKER_USERNAME }}/${{ secrets.DOCKER_REPO }}
            COLOR_FILE=/home/ubuntu/deploy_color

            # 현재 색 / 다음 색 / 포트 결정
            if [ -f "$COLOR_FILE" ] && [ "$(cat $COLOR_FILE)" = "blue" ]; then
              CURRENT_COLOR=blue
              NEW_COLOR=green
              CURRENT_PORT=8080
              NEW_PORT=8081
            else
              CURRENT_COLOR=green
              NEW_COLOR=blue
              CURRENT_PORT=8081
              NEW_PORT=8080
            fi

            echo "Current color: $CURRENT_COLOR"
            echo "New color: $NEW_COLOR"

            docker pull "$IMAGE"

            NEW_CONTAINER_NAME="${APP_NAME}-${NEW_COLOR}"
            OLD_CONTAINER_NAME="${APP_NAME}-${CURRENT_COLOR}"

            # 새 컨테이너 자리에 기존 게 있으면 정리
            if [ "$(docker ps -aq -f name=$NEW_CONTAINER_NAME)" ]; then
              echo "Removing existing container on new slot: $NEW_CONTAINER_NAME"
              docker stop "$NEW_CONTAINER_NAME" || true
              docker rm "$NEW_CONTAINER_NAME" || true
            fi

            echo "Starting new container on port ${NEW_PORT}..."
            docker run -d \
              --name "$NEW_CONTAINER_NAME" \
              -e SPRING_PROFILES_ACTIVE=prod \
              -e "JAVA_TOOL_OPTIONS=-Duser.timezone=Asia/Seoul" \
              -e "MYSQL_URL=${{ secrets.MYSQL_URL }}" \
              -e "MYSQL_USERNAME=${{ secrets.MYSQL_USERNAME }}" \
              -e "MYSQL_PASSWORD=${{ secrets.MYSQL_PASSWORD }}" \
              -e "JWT_SECRET=${{ secrets.JWT_SECRET }}" \
              -e "RPC_URL=${{ secrets.RPC_URL }}" \
              -e "BADGE_CONTRACT_ADDRESS=${{ secrets.BADGE_CONTRACT_ADDRESS }}" \
              -e "DONATION_CONTRACT_ADDRESS=${{ secrets.DONATION_CONTRACT_ADDRESS }}" \
              -e "OWNER_PRIVATE_KEY=${{ secrets.OWNER_PRIVATE_KEY }}" \
              -p "${NEW_PORT}:8080" \
              "$IMAGE"

            HEALTH_PATH="/api/rankings"

            echo "Health check for new container..."
            for i in {1..20}; do
              sleep 5
              STATUS_CODE=$(curl -s -o /dev/null -w "%{http_code}" "http://localhost:${NEW_PORT}${HEALTH_PATH}" || echo "000")
              echo "Health check status: $STATUS_CODE"

              if [ "$STATUS_CODE" = "200" ]; then
                echo "New version is healthy!"
                break
              fi

              if [ "$i" -eq 20 ]; then
                echo "New version did not become healthy in time. Aborting."
                docker logs "$NEW_CONTAINER_NAME" || true
                exit 1
              fi
            done

            echo "Switching traffic to new container on port ${NEW_PORT}..."

            sudo sed -i "s/reverse_proxy localhost:[0-9]\\+/reverse_proxy localhost:${NEW_PORT}/" /etc/caddy/Caddyfile
            sudo systemctl reload caddy

            if [ "$(docker ps -q -f name=$OLD_CONTAINER_NAME)" ]; then
              echo "Stopping old container: $OLD_CONTAINER_NAME"
              docker stop "$OLD_CONTAINER_NAME" || true
              docker rm "$OLD_CONTAINER_NAME" || true
            fi

            docker image prune -f
            
            echo "$NEW_COLOR" > "$COLOR_FILE"
            echo "Deployment complete. Current color is now $(cat $COLOR_FILE)."